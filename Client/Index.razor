@namespace Oqtane.ChatHubs
@inherits IndexBase

@using Microsoft.AspNetCore.SignalR.Client
@using System.Collections.Generic
@using System.Linq
@using BlazorAlerts
@using BlazorWindows
@using BlazorTabs
@using BlazorVideo
@using Oqtane.ChatHubs.Models
@using Oqtane.ChatHubs.Enums
@using BlazorDropdown

<link href="/Modules/Oqtane.ChatHubs/blazoralerts.min.css" rel="stylesheet" />
<link href="/Modules/Oqtane.ChatHubs/chat-hub-stylesheets.css" rel="stylesheet" />

<div id="chathub-module-@ModuleState.ModuleId" class="chathubs-container p-sm-3 mb-4" style="opacity: 0;">

    <TabContainer>

        <TabItem>
            <TabTitle>Lobby</TabTitle>
            <TabContent>

                @if (PageState.QueryString.ContainsKey("moduleid") && PageState.QueryString.ContainsKey("roomid") && int.Parse(PageState.QueryString["moduleid"]) == ModuleState.ModuleId)
                {
                    if (ChatHubService.Lobbies?.Count > 0)
                    {
                        <div>

                            <div class="jumbotron jumbotron-fluid px-1 px-sm-3 py-sm-3 py-5 mb-0" style="background-color: transparent">
                                <div class="container">
                                    <h1 class="display-4">@contextRoom?.Title</h1>
                                    <p class="lead">Posted by @contextRoom?.Creator.DisplayName on @contextRoom?.CreatedOn.ToShortDateString()</p>
                                    <NavLink class="btn btn-secondary" href="@NavigateUrl()">View All Rooms</NavLink>
                                </div>
                            </div>

                        </div>
                    }
                }
                else
                {

                    <div class="jumbotron jumbotron-fluid px-1 px-sm-3 py-sm-3 py-5 mb-0" style="background-color: transparent">
                        <div class="container">

                            <div class="d-flex flex-wrap flex-sm-nowrap align-items-center">

                                <div class="p-0 pe-sm-3">

                                    <img src="https://raw.githubusercontent.com/boredanyway/aspnetcore.chathub.template/master/screenshot1.png" class="img-fluid" alt="preview" style="max-width: 256px;" />

                                </div>

                                <div class="p-0 ps-sm-3">

                                    <h1 class="display-4">Video chat app</h1>

                                    <p class="lead">This is a base video chat implementation in its beta version but free to use and have fun. Create a new post and start videochatting with friends or strangers.</p>

                                    <ChatConnect GuestUsername="@GuestUsername"></ChatConnect>

                                </div>

                            </div>

                        </div>
                    </div>

                    @if (ChatHubService.Connection?.State == HubConnectionState.Connected)
                    {
                        <div class="d-flex justify-content-between bd-highlight mt-4">
                            <div class="flex-fill bd-highlight bg-yellow p-md-3 px-2 py-1 px-md-5 py-md-4">
                                <small style="font-family: Consolas, monospace;">
                                    Connected as @ChatHubService.ConnectedUser?.DisplayName
                                </small>
                            </div>
                            <div class="flex-fill bd-highlight bg-light p-1 p-md-4">
                                <button type="button" @onclick="@(() => EditRoomModalRef.OpenCreateRoomModal())" class="btn btn-sm btn-link w-100 bg-transparent">Add new post</button>
                            </div>
                        </div>
                    }

                    <ChatLobbies EditRoomModalRef="@EditRoomModalRef"></ChatLobbies>

                }

            </TabContent>
        </TabItem>

        @if (ChatHubService.Connection?.State == HubConnectionState.Connected && ChatHubService.Rooms.Any())
        {

            <TabItem>
                <TabTitle>
                    @ModuleState.ModuleDefinition.Name
                </TabTitle>
                <TabContent>

                    @if (ChatHubService.Rooms.Any())
                    {

                        List<BlazorDropdownItem> dropdownItems = new List<BlazorDropdownItem>();
                        foreach (var room in ChatHubService.Rooms)
                        {
                            dropdownItems.Add(new BlazorDropdownItem() { Id = room.Id, Name = $"{room.Title} Settings" });
                        }
                       
                        <div class="position-fixed d-md-none" style="top: 65px; right: 10px; z-index: 1040;">
                            <BlazorDropdownComponent DropdownItemClicked="@SettingsDropdown_Clicked" DropdownItemModels="@dropdownItems"></BlazorDropdownComponent>
                        </div>

                        <WindowContainer RenderLivestreams="@true" DraggableLivestreamContainerElementId="@DraggableLivestreamsContainerElementId" ShowEvent="@ShowWindow" HideEvent="@HideWindow" ShownEvent="@ShownWindow" HiddenEvent="@HiddenWindow" AddedEvent="@AddedWindow" RemovedEvent="@RemovedWindow">

                            @foreach (var item in ChatHubService.Rooms.Where(item => item.ModuleId == ModuleState.ModuleId).Select((value, i) => new { value, i }))
                            {

                                ChatHubRoom room = item.value;
                                int room_index = item.i;

                                <WindowItem @key="room" Id="@room.Id" IsActiveWindow="@(ChatHubService.ContextRoomId == room.Id.ToString())">
                                    <WindowTitle>

                                        @room.Title&nbsp;
                                        <div class="badge badge-warning @(room.UnreadMessages != 0 ? "" : "d-none")">@room.UnreadMessages</div>

                                        <span class="position-absolute" @onclick="async () => await LeaveRoom_Clicked(room.Id, ModuleState.ModuleId)" style="top: 0px; right: 0px;">
                                            <span class="oi oi-circle-x"></span>
                                        </span>

                                    </WindowTitle>
                                    <WindowLivestream>

                                        @if (ChatHubService.ConnectedUser?.UserId == room.CreatorId)
                                        {
                                            <BlazorVideoComponent Id="@room.Id.ToString()" ConnectionId="@ChatHubService.Connection?.ConnectionId" Type="@BlazorVideoType.LocalLivestream" BackgroundColor="@room.BackgroundColor" Name="@room.Title" Status="@(room.Creator.Connections.Any(c => room.Cams.Any(cam => cam.ChatHubConnectionId == c.Id && cam.Status == ChatHubCamStatus.Broadcasting.ToString())) ? BlazorVideoStatusType.Live : BlazorVideoStatusType.Offline)" Viewers="@room.Viewers.Count()" Framerate="@framerate" VideoBitsPerSecond="@videoBitsPerSecond" AudioBitsPerSecond="@audioBitsPerSecond" VideoSegmentsLength="@videoSegmentsLength"></BlazorVideoComponent>
                                        }
                                        else
                                        {
                                            if (room.Creator != null)
                                            {
                                                if (!room.Creator.Connections.Any())
                                                {
                                                    <div class="card bg-light" style="width: 240px; height: 180px;">
                                                        <div class="card-body">
                                                            <h6 class="card-subtitle mb-2 text-muted">@room.Title</h6>
                                                            <p class="card-text">No video found from room creator @(room.Creator.Username).</p>
                                                        </div>
                                                    </div>
                                                }
                                                foreach (var connection in room.Creator.Connections)
                                                {
                                                    BlazorVideoStatusType status = BlazorVideoStatusType.Offline;
                                                    var broadcastingCams = connection.Cams.Where(cam => cam.Status == ChatHubCamStatus.Broadcasting.ToString()).ToList();
                                                    if (room.Cams.Any(cam => broadcastingCams.Any(item => cam.Id == item.Id)))
                                                    {
                                                        status = BlazorVideoStatusType.Live;
                                                    }

                                                    <BlazorVideoComponent Id="@room.Id.ToString()" ConnectionId="@connection.ConnectionId" Type="@BlazorVideoType.RemoteLivestream" BackgroundColor="@room.BackgroundColor" Name="@room.Title" Status="@status" Viewers="@room.Viewers.Count()" Framerate="@framerate" VideoBitsPerSecond="@videoBitsPerSecond" AudioBitsPerSecond="@audioBitsPerSecond" VideoSegmentsLength="@videoSegmentsLength"></BlazorVideoComponent>
                                                }
                                            }
                                        }

                                    </WindowLivestream>
                                    <WindowContent>

                                        <div class="d-flex">
                                            <div class="@(room.ShowUserlist ? "d-none" : "d-flex flex-fill")">
                                                
                                                <ChatRoom room="@room" Settings="@settings" ImageModalRef="@ImageModalRef" MessageWindowHeight="@MessageWindowHeight"></ChatRoom>

                                            </div>

                                            <div class="userlist bg-light p-0 p-sm-2 w-100 @(room.ShowUserlist ? "flex-fill d-flex" : "d-none d-xl-flex")" style="min-width: 340px; max-width: 340px">
                                                
                                                <ChatUserlist room="@room" SettingsModalRef="@SettingsModalRef" UserlistWindowHeight="@UserlistWindowHeight"></ChatUserlist>

                                            </div>

                                        </div>

                                    </WindowContent>
                                </WindowItem>

                            }
                        </WindowContainer>

                    }

                </TabContent>
            </TabItem>

        }
        @if (ChatHubService.Connection?.State == HubConnectionState.Connected)
        {

            <TabItem>
                <TabTitle>
                    Settings
                </TabTitle>
                <TabContent>

                    <ChatSettings></ChatSettings>

                </TabContent>
            </TabItem>

        }

        <TabItem>
            <TabTitle>About</TabTitle>
            <TabContent>

                <ChatAbout></ChatAbout>

            </TabContent>
        </TabItem>

    </TabContainer>

    <div class="d-flex flex-column my-2 px-2">

        <div class="ms-auto bg-yellow">
            <small>
                <a href="https://github.com/boredanyway/aspnetcore.chathub.template" target="_blank" title="oqtane chathub module">Wasmchat Project At Github</a>
            </small>
        </div>

    </div>

    <BlazorAlertsComponent></BlazorAlertsComponent>

</div>

<SettingsModal @ref="SettingsModalRef"></SettingsModal>
<ImageModal @ref="ImageModalRef"></ImageModal>
<EditRoomModal @ref="EditRoomModalRef"></EditRoomModal>

@code {

}