@namespace Oqtane.ChatHubs
@inherits ModuleBase
@using System.Text.RegularExpressions

@inject NavigationManager NavigationManager
@inject HttpClient http
@inject ISettingService SettingService

<div class="mb-3">
    <label for="maxUsernameChars" class="form-label">Maximum username characters</label>
    <input type="text" class="form-control" id="maxUsernameChars" @bind="maxUserNameCharacters">
</div>

<div class="mb-3">
    @foreach (var item in regularExpressions)
    {
        <div class="d-flex flex-row">
            <div><small><strong>@item</strong></small></div>
            <div><button type="button" class="btn btn-link" @onclick="@(() => RemoveRegularExpression_ClickedAsync(item))">Remove</button></div>        
        </div>
    }
</div>

<div class="mb-3">
    <input type="text" class="form-control" @bind="regularExpression" placeholder="Type your regular expression.." />
    <br />
    <small class="form-text text-muted">Try this regex for youtube links: <br />(?:http?s?:\/\/)?(?:www.)?(?:m.)?(?:music.)?youtu(?:\.?be)(?:\.com)?(?:(?:\w*.?:\/\/)?\w*.?\w*-?.?\w*\/(?:embed|e|v|watch|.*\/)?\??(?:feature=\w*\.?\w*)?&?(?:v=)?\/?)([\w\d_-]{11})(?:\S+)?</small>
    <br />
    <button type="button" class="btn btn-link" @onclick="@(() => AddRegularExpression_ClickedAsync())">Add</button>
</div>

@code {

    public string maxUserNameCharacters;
    public string regularExpression;
    public List<string> regularExpressions = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Dictionary<string, string> settings = await SettingService.GetModuleSettingsAsync(ModuleState.ModuleId);

            maxUserNameCharacters = SettingService.GetSetting(settings, "MaxUserNameCharacters", "20");
            regularExpressions = SettingService.GetSetting(settings, "RegularExpression", "").Split(";delimiter;", StringSplitOptions.RemoveEmptyEntries).ToList();
        }
        catch (Exception ex)
        {
            ModuleInstance.AddModuleMessage(ex.Message, MessageType.Error);
        }
    }

    public async Task UpdateSettings()
    {
        try
        {
            Dictionary<string, string> settings = await SettingService.GetModuleSettingsAsync(ModuleState.ModuleId);

            SettingService.SetSetting(settings, "MaxUserNameCharacters", maxUserNameCharacters);
            await SettingService.UpdateModuleSettingsAsync(settings, ModuleState.ModuleId);

            SettingService.SetSetting(settings, "RegularExpression", string.Join(";delimiter;", regularExpressions));
            await SettingService.UpdateModuleSettingsAsync(settings, ModuleState.ModuleId);
        }
        catch (Exception ex)
        {
            ModuleInstance.AddModuleMessage(ex.Message, MessageType.Error);
        }
    }

    public void AddRegularExpression_ClickedAsync()
    {
        try
        {
            this.regularExpressions.Add(regularExpression);
            this.regularExpression = string.Empty;
        }
        catch (Exception ex)
        {
            ModuleInstance.AddModuleMessage(ex.Message, MessageType.Error);
        }
    }

    public void RemoveRegularExpression_ClickedAsync(string item)
    {
        try
        {
            this.regularExpressions.Remove(item);
        }
        catch (Exception ex)
        {
            ModuleInstance.AddModuleMessage(ex.Message, MessageType.Error);
        }
    }
}